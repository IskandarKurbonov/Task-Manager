{% extends 'base.html' %}

{% block title %}Детали проекта - {{ project.name }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок -->
    <h2 class="mb-4">Проект: {{ project.name }}</h2>

    <!-- Кнопка редактирования проекта -->
    <button class="btn btn-warning mb-3" type="button" data-toggle="collapse" data-target="#editProjectForm" aria-expanded="false">
        <i class="fas fa-pencil-alt"></i> Редактировать проект
    </button>

    <!-- Блок информации о проекте -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Описание проекта</h5>
            <p><strong>Описание:</strong> {{ project.description }}</p>
            <p><strong>Ответственный:</strong> {{ project.manager.full_name if project.manager else "Не назначен" }}</p>
            <p><strong>Дедлайн:</strong> {{ project.deadline if project.deadline else "Не установлен" }}</p>
            <p><strong>Статус:</strong> {{ project.status.name }}</p>
        </div>
    </div>

    <!-- Список загруженных файлов -->
    <h3 class="mt-4">Файлы</h3>
    <ul class="list-group mb-4">
        {% for filename in os.listdir(project_files_path) %}
            <li class="list-group-item">
                <a href="{{ url_for('main_routes.download_file', project_id=project.id, filename=filename) }}">
                    {{ filename }}
                </a>
            </li>
        {% else %}
            <li class="list-group-item text-muted" style="margin-bottom: 10px;">Файлов нет.</li>
        {% endfor %}
    </ul>

    <!-- Кнопка загрузки файла -->
    <button class="btn btn-success mb-3" type="button" data-toggle="collapse" data-target="#uploadFileForm" aria-expanded="false">
        <i class="fas fa-upload"></i> Загрузить файл
    </button>

    <!-- Форма для загрузки файла -->
    <div class="collapse" id="uploadFileForm">
        <div class="card card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file" class="font-weight-bold">Выберите файл</label>
                    <div class="custom-file">
                        <input type="file" name="file" class="custom-file-input" id="file" required />
                        <label class="custom-file-label" for="file">Выберите файл...</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Загрузить</button>
            </form>
        </div>
    </div>


    <!-- Стили для улучшения поля выбора файла -->
    <style>
        .custom-file-label::after {
            content: "Выберите файл...";
        }
        .custom-file-input:lang(en)~.custom-file-label::after {
            content: "Выберите файл...";
        }
        .custom-file {
            position: relative;
            width: 100%;
        }
        .custom-file-input {
            position: absolute;
            z-index: 1;
            width: 100%;
            height: calc(2.25rem + 2px);
            opacity: 0;
        }
        .custom-file-label {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            height: calc(2.25rem + 2px);
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .custom-file-input:focus~.custom-file-label {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(38, 143, 255, 0.25);
        }
    </style>

    <!-- Скрипт для отображения имени выбранного файла -->
    <script>
        // Когда файл выбран, обновляется текст метки
        document.getElementById("file").addEventListener("change", function(event) {
            var fileName = event.target.files[0].name;
            var label = event.target.nextElementSibling;
            label.innerText = fileName; // Обновление текста на имя файла
        });
    </script>


    <!-- Список задач -->
    <h3 class="mt-4">Задачи проекта</h3>
    <ul class="list-group mb-4">
        {% for task in tasks %}
            <li class="list-group-item">
                <h5>{{ task.title }}</h5>
                <p><strong>Ответственный:</strong> {{ task.assigned_user.full_name }}</p>
                <p><strong>Статус:</strong>
                    {{ task.status.name }}
                    <button class="btn btn-link p-0" data-toggle="modal" data-target="#editStatusModal{{ task.id }}">
                        <i class="fas fa-pencil-alt" style="color: blue; font-size: 0.8rem; vertical-align: center;"></i>
                    </button>
                </p>
                <p><strong>Приоритет:</strong>
                    {% if task.priority == 1 %} Высокий
                    {% elif task.priority == 2 %} Средний
                    {% elif task.priority == 3 %} Низкий
                    {% endif %}
                </p>
                <p><strong>Дедлайн:</strong> {{ task.deadline }}</p>

                <!-- Спойлер для описания задачи и комментариев -->
                <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#taskDetails{{ task.id }}" aria-expanded="false" aria-controls="taskDetails{{ task.id }}">
                    Подробнее
                </button>

                <div class="collapse" id="taskDetails{{ task.id }}">
                    <div class="card mt-3">
                        <div class="card-body">
                            <!-- Список комментариев для задачи -->
                            <div class="chat-section mt-4">
                                <h4>Комментарии:</h4>
                                <div class="chat-box mt-3">
                                    {% for comment in comments if comment.task_id == task.id %}
                                        <div class="chat-message mb-3">
                                            <div class="message-header">
                                                <strong>{{ comment.user.full_name }}</strong>
                                                <span class="message-time text-muted ml-2">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                            </div>
                                            <div class="message-content bg-light p-2 rounded">
                                                {{ comment.content }}
                                            </div>
                                        </div>
                                    <!-- Стили для оформления чата -->
                                    <style>
                                        .chat-box {
                                            max-height: 400px;
                                            overflow-y: auto;
                                            padding: 10px;
                                            background-color: #f9f9f9;
                                            border-radius: 10px;
                                            border: 1px solid #e0e0e0;
                                        }
                                        .chat-message {
                                            background-color: #fff;
                                            border-radius: 10px;
                                            padding: 10px;
                                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                                        }
                                        .message-header {
                                            font-size: 14px;
                                            color: #333;
                                        }
                                        .message-content {
                                            margin-top: 5px;
                                            font-size: 16px;
                                        }
                                        .message-time {
                                            font-size: 12px;
                                        }
                                        .add-comment-form {
                                            background-color: #fafafa;
                                            padding: 15px;
                                            border-radius: 10px;
                                            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                                        }
                                    </style>

                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Форма добавления комментария -->
                            <div class="add-comment-form mt-4">
                                <h4>Написать комментарий:</h4>
                                <form method="POST" action="{{ url_for('main_routes.project_details', project_id=project.id) }}">
                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                    <input type="hidden" name="project_id" value="{{ project.id }}">

                                    <div class="form-group">
                                        <label for="content">Ваш комментарий:</label>
                                        <textarea name="content" class="form-control" rows="4" required></textarea>
                                    </div>

                                    <button type="submit" class="btn btn-primary mt-2">Отправить</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        {% else %}
            <li class="list-group-item text-muted">Задач нет.</li>
        {% endfor %}
    </ul>

    <!-- Форма добавления задачи -->
    <button class="btn btn-primary mb-3" type="button" data-toggle="collapse" data-target="#addTaskForm" aria-expanded="false">
        <i class="fas fa-plus"></i> Добавить задачу
    </button>
    <div class="collapse" id="addTaskForm">
        <div class="card card-body">
            <form method="POST" action="{{ url_for('main_routes.create_task', project_id=project.id) }}">
                <div class="form-group">
                    <label for="title">Название задачи</label>
                    <input type="text" name="title" class="form-control" required />
                </div>
                <div class="form-group">
                    <label for="assigned_to">Ответственный</label>
                    <select name="assigned_to" class="form-control" required>
                        <option value="">Выберите ответственного</option>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="status_id">Статус</label>
                    <select name="status_id" class="form-control" required>
                        <option value="">Выберите статус</option>
                        {% for status in statuses %}
                            <option value="{{ status.id }}">{{ status.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="priority">Приоритет</label>
                    <select name="priority" class="form-control" required>
                        <option value="">Выберите приоритет</option>
                        <option value="1">Высокий</option>
                        <option value="2">Средний</option>
                        <option value="3">Низкий</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deadline">Дедлайн</label>
                    <input type="date" name="deadline" class="form-control" required />
                </div>
                <button type="submit" class="btn btn-success">Добавить задачу</button>
            </form>
        </div>
    </div>

</div>
{% endblock %}
