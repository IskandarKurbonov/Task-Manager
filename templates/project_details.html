{% extends 'base.html' %}

{% block title %}Детали проекта - {{ project.name }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок -->
    <h2 class="mb-4">Проект: {{ project.name }}</h2>

    <!-- Кнопка редактирования проекта -->
    <button class="btn btn-warning mb-3" type="button" data-toggle="collapse" data-target="#editProjectForm" aria-expanded="false">
        <i class="fas fa-pencil-alt"></i> Редактировать проект
    </button>

    <!-- Блок информации о проекте -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Описание проекта</h5>
            <p><strong>Описание:</strong> {{ project.description }}</p>
            <p><strong>Ответственный:</strong> {{ project.manager.full_name if project.manager else "Не назначен" }}</p>
            <p><strong>Дедлайн:</strong> {{ project.deadline if project.deadline else "Не установлен" }}</p>
            <p><strong>Статус:</strong> {{ project.status.name }}</p>
        </div>
    </div>

    <!-- Список загруженных файлов -->
    <h3 class="mt-4">Файлы</h3>
    <ul class="list-group mb-4">
        {% for filename in os.listdir(project_files_path) %}
            <li class="list-group-item">
                <a href="{{ url_for('main_routes.download_file', project_id=project.id, filename=filename) }}">
                    {{ filename }}
                </a>
            </li>
        {% else %}
            <li class="list-group-item text-muted" style="margin-bottom: 10px;">Файлов нет.</li>
        {% endfor %}
    </ul>

    <!-- Кнопка загрузки файла -->
    <button class="btn btn-success mb-3" type="button" data-toggle="collapse" data-target="#uploadFileForm" aria-expanded="false">
        <i class="fas fa-upload"></i> Загрузить файл
    </button>

    <!-- Форма для загрузки файла -->
    <div class="collapse" id="uploadFileForm">
        <div class="card card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file" class="font-weight-bold">Выберите файл</label>
                    <div class="custom-file">
                        <input type="file" name="file" class="custom-file-input" id="file" required />
                        <label class="custom-file-label" for="file">Выберите файл...</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Загрузить</button>
            </form>
        </div>
    </div>

    <!-- Список задач -->
    <h3 class="mt-4">Задачи проекта</h3>
    <ul class="list-group mb-4">
        {% for task in tasks %}
            <li class="list-group-item">
                <h5>{{ task.title }}</h5>
                <p><strong>Ответственный:</strong>
                    <img src="{{ task.assigned_user.profile_picture if task.assigned_user.profile_picture else url_for('static', filename='default_profile_picture.jpg') }}" alt="Профиль" style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px; border-radius: 50%; vertical-align: middle;">
                    {{ task.assigned_user.full_name }}
                </p>
                <p><strong>Статус:</strong>
                    {{ task.status.name }}
                    <button class="btn btn-link p-0" data-toggle="modal" data-target="#editStatusModal{{ task.id }}">
                        <i class="fas fa-pencil-alt" style="color: blue; font-size: 0.8rem; vertical-align: center;"></i>
                    </button>
                </p>
                <p><strong>Приоритет:</strong>
                    {% if task.priority == 1 %} Высокий
                    {% elif task.priority == 2 %} Средний
                    {% elif task.priority == 3 %} Низкий
                    {% endif %}
                </p>
                <p><strong>Дедлайн:</strong> {{ task.deadline }}</p>

                <!-- Модальное окно для редактирования статуса задачи -->
                <div class="modal fade" id="editStatusModal{{ task.id }}" tabindex="-1" role="dialog" aria-labelledby="editStatusModalLabel{{ task.id }}" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editStatusModalLabel{{ task.id }}">Изменить статус задачи</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <form method="POST" action="{{ url_for('main_routes.update_task_status', task_id=task.id) }}">
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="status">Выберите статус</label>
                                        <select name="status_id" class="form-control" required>
                                            {% for status in statuses %}
                                                <option value="{{ status.id }}" {% if task.status.id == status.id %} selected {% endif %}>
                                                    {{ status.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </li>
        {% else %}
            <li class="list-group-item text-muted">Задач нет.</li>
        {% endfor %}
    </ul>


    <!-- Форма добавления задачи -->
    <button class="btn btn-primary mb-3" type="button" data-toggle="collapse" data-target="#addTaskForm" aria-expanded="false">
        <i class="fas fa-plus"></i> Добавить задачу
    </button>
    <div class="collapse" id="addTaskForm">
        <div class="card card-body">
            <form method="POST" action="{{ url_for('main_routes.create_task', project_id=project.id) }}">
                <div class="form-group">
                    <label for="title">Название задачи</label>
                    <input type="text" name="title" class="form-control" required />
                </div>
                <div class="form-group">
                    <label for="assigned_to">Ответственный</label>
                    <select name="assigned_to" class="form-control" required>
                        <option value="">Выберите ответственного</option>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="status_id">Статус</label>
                    <select name="status_id" class="form-control" required>
                        <option value="">Выберите статус</option>
                        {% for status in statuses %}
                            <option value="{{ status.id }}">{{ status.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="priority">Приоритет</label>
                    <select name="priority" class="form-control" required>
                        <option value="">Выберите приоритет</option>
                        <option value="1">Высокий</option>
                        <option value="2">Средний</option>
                        <option value="3">Низкий</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deadline">Дедлайн</label>
                    <input type="date" name="deadline" class="form-control" required />
                </div>
                <button type="submit" class="btn btn-primary">Создать задачу</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
