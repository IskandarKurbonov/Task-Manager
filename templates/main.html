{% extends "base.html" %}

{% block title %}Проекты{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Левая панель проектов -->
        <div class="col-md-3 px-3 py-4 shadow-sm" style="height: 100vh; position: fixed; border-radius: 15px; background-color: #e3f2fd;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="font-weight-bold">Проекты</h5>
                <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#createProjectModal">+</button>
            </div>
            <ul class="list-group list-group-flush">
                {% if projects|length > 0 %}
                    {% for project in projects %}
                    <li class="d-flex align-items-center py-2" style="border-bottom: 1px solid #ddd;">
                        <i class="fas fa-folder text-primary mr-2 project-icon" data-project-id="{{ project.id }}"></i>
                        <a href="{{ url_for('main_routes.main', project_id=project.id) }}" class="text-decoration-none text-dark">{{ project.name }}</a>
                    </li>
                    {% endfor %}
                {% else %}
                    <li class="text-center text-muted py-2" style="border: none;">Нет доступных проектов</li>
                {% endif %}
            </ul>
        </div>

        <!-- Основное содержимое -->
        <div class="col-md-8 offset-md-3" style="font-family: 'Arial', sans-serif; padding-left: 20px;">
            {% if selected_project %}
            <div class="mt-4">
                <ul class="nav nav-tabs mb-4" id="projectTabs" role="tablist" style="border-bottom: 2px solid #ddd;">
                    <li class="nav-item">
                        <a class="nav-link active" id="description-tab" data-toggle="tab" href="#description" role="tab" aria-controls="description" aria-selected="true" style="font-weight: bold; color: #007bff;">
                            <i class="fas fa-info-circle mr-2"></i>Описание
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tasks-tab" data-toggle="tab" href="#tasks" role="tab" aria-controls="tasks" aria-selected="false" style="font-weight: bold; color: #28a745;">
                            <i class="fas fa-tasks mr-2"></i>Задачи
                        </a>
                    </li>
                </ul>
                <div class="tab-content" id="projectTabsContent">
                    <!-- Описание проекта -->
                    <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab" style="background-color: #e3f2fd; padding: 20px; border-radius: 10px;">
                        <h1>{{ selected_project.name }}</h1>
                        <p class="text-muted"><i class="fas fa-file-alt" style="color: #28a745;"></i> {{ selected_project.description }}</p>
                        <p><i class="fas fa-calendar-alt" style="color: #ffc107;"></i> <strong>Срок завершения:</strong> {{ selected_project.deadline.strftime('%d.%m.%Y') if selected_project.deadline else 'Не установлен' }}</p>
                        <p class="d-flex align-items-center">
                            <i class="fas fa-user-tie" style="color: #17a2b8;"></i>
                            <strong class="ml-2">Менеджер:</strong>
                            {% if selected_project.manager %}
                                <a href="#" data-toggle="modal" data-target="#managerInfoModal" class="d-flex align-items-center text-decoration-none ml-2">
                                    <img src="{{ url_for('static', filename=selected_project.manager.profile_picture or 'users/default_profile_picture.jpg') }}"
                                         alt="Фото менеджера"
                                         class="rounded-circle mr-2"
                                         style="width: 30px; height: 30px; object-fit: cover;">
                                    <span>{{ selected_project.manager.full_name }}</span>
                                </a>
                            {% else %}
                                <span class="ml-2">Не назначен</span>
                            {% endif %}
                        </p>
                        <!-- Статистика задач -->
                        <div class="mt-4" style="background-color: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4 class="text-center">Статистика задач</h4>
                            <canvas id="taskStatsChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                    <!-- Задачи проекта -->
                    <div class="tab-pane fade" id="tasks" role="tabpanel" aria-labelledby="tasks-tab" style="background-color: #d4edda; padding: 20px; border-radius: 10px;">
                        <h2 class="text-center">Задачи</h2>

                        <!-- Three columns for task statuses -->
                        <div class="row mt-4">
                            <!-- To Do Column -->
                            <div class="col-md-4">
                                <div class="card shadow-sm" style="border-radius: 10px;">
                                    <div class="card-header bg-primary text-white text-center" style="border-radius: 10px 10px 0 0;">
                                        <strong>К выполнению</strong>
                                    </div>
                                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                        {% for task in selected_project.tasks if task.status.name == 'К выполнению' %}
                                        <div class="card mb-3 shadow-sm">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-tasks text-info"></i> {{ task.title }}
                                                </h6>
                                                <button class="btn btn-sm btn-outline-info" data-toggle="collapse" data-target="#task-{{ task.id }}" aria-expanded="false" aria-controls="task-{{ task.id }}">Подробнее</button>
                                                <div class="collapse mt-2" id="task-{{ task.id }}">
                                                    <p><i class="fas fa-align-left text-primary"></i> {{ task.description }}</p>
                                                    <p><i class="fas fa-calendar-alt text-warning"></i> <strong>Дедлайн:</strong> {{ task.deadline.strftime('%d.%m.%Y') if task.deadline else 'Не установлен' }}</p>
                                                    <p><i class="fas fa-user-friends text-success"></i> <strong>Ответственные:</strong>
                                                        {% if task.assigned_users %}
                                                        {% for assigned_user in task.assigned_users %}
                                                        <a href="#" data-toggle="modal" data-target="#userInfoModal-{{ assigned_user.user.id }}" class="d-flex align-items-center text-decoration-none mt-2">
                                                            <img src="{{ url_for('static', filename=assigned_user.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                 alt="Фото профиля"
                                                                 class="rounded-circle mr-2"
                                                                 style="width: 30px; height: 30px; object-fit: cover;">
                                                            <span>{{ assigned_user.user.full_name }}</span>
                                                        </a>

                                                        <!-- Модальное окно -->
                                                        <div class="modal fade" id="userInfoModal-{{ assigned_user.user.id }}" tabindex="-1" role="dialog" aria-labelledby="userInfoModalLabel-{{ assigned_user.user.id }}" aria-hidden="true">
                                                            <div class="modal-dialog" role="document">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="userInfoModalLabel-{{ assigned_user.user.id }}">{{ assigned_user.user.full_name }}</h5>
                                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body text-center">
                                                                        <img src="{{ url_for('static', filename=assigned_user.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                             alt="Фото профиля"
                                                                             class="rounded-circle mb-3"
                                                                             style="width: 100px; height: 100px; object-fit: cover;">
                                                                        <h5>{{ assigned_user.user.full_name }}</h5>
                                                                        <p><strong>Внутренний номер:</strong> {{ assigned_user.user.internal_id }}</p>
                                                                        <p><strong>Email:</strong> {{ assigned_user.user.email }}</p>
                                                                        <p><strong>Телефон:</strong> {{ assigned_user.user.phone_number }}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                        {% else %}
                                                        <span class="text-muted">Не назначены</span>
                                                        {% endif %}
                                                    </p>

                                                    <!-- Chat-style Comments -->
                                                    <h6 class="mt-3"><i class="fas fa-comments text-info"></i> Комментарии:</h6>
                                                    <div class="chat-container p-3" style="background-color: #f8f9fa; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                                                        {% for comment in task.comments|reverse %}
                                                        <div class="d-flex align-items-start mb-3">
                                                            <img src="{{ url_for('static', filename=comment.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                 alt="Фото профиля"
                                                                 class="rounded-circle mr-3"
                                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                                            <div class="p-2 rounded" style="background-color: #e3f2fd; border: 1px solid #ddd; border-radius: 10px; max-width: 80%;">
                                                                <strong class="text-primary">{{ comment.user.full_name }}</strong>
                                                                <p class="mb-1">{{ comment.content }}</p>
                                                                <small class="text-muted">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                        {% if not task.comments %}
                                                        <p class="text-muted text-center">Комментариев пока нет.</p>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Add Comment Form -->
                                                    <form action="{{ url_for('main_routes.add_comment') }}" method="POST" class="mt-3">
                                                        <input type="hidden" name="task_id" value="{{ task.id }}">
                                                        <div class="form-group">
                                                            <label for="commentContent-{{ task.id }}">Добавить комментарий:</label>
                                                            <textarea class="form-control" id="commentContent-{{ task.id }}" name="content" rows="2" required></textarea>
                                                        </div>
                                                        <button type="submit" class="btn btn-sm btn-primary">Отправить</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <p class="text-center text-muted">Нет задач</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- In Progress Column -->
                            <div class="col-md-4">
                                <div class="card shadow-sm" style="border-radius: 10px;">
                                    <div class="card-header bg-warning text-dark text-center" style="border-radius: 10px 10px 0 0;">
                                        <strong>В процессе</strong>
                                    </div>
                                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                        {% for task in selected_project.tasks if task.status.name == 'В процессе' %}
                                        <div class="card mb-3 shadow-sm">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-tasks text-info"></i> {{ task.title }}
                                                </h6>
                                                <button class="btn btn-sm btn-outline-warning" data-toggle="collapse" data-target="#task-{{ task.id }}" aria-expanded="false" aria-controls="task-{{ task.id }}">Подробнее</button>
                                                <div id="task-{{ task.id }}" class="collapse mt-2">
                                                    <p><i class="fas fa-align-left text-primary"></i> {{ task.description }}</p>
                                                    <p><i class="fas fa-calendar-alt text-warning"></i> <strong>Дедлайн:</strong> {{ task.deadline.strftime('%d.%m.%Y') if task.deadline else 'Не установлен' }}</p>
                                                    <p><i class="fas fa-user-friends text-success"></i> <strong>Ответственные:</strong>
                                                        {% if task.assigned_users %}
                                                        {% for assigned_user in task.assigned_users %}
                                                        <a href="#" data-toggle="modal" data-target="#userInfoModal-{{ assigned_user.user.id }}" class="d-flex align-items-center text-decoration-none mt-2">
                                                            <img src="{{ url_for('static', filename=assigned_user.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                 alt="Фото профиля"
                                                                 class="rounded-circle mr-2"
                                                                 style="width: 30px; height: 30px; object-fit: cover;">
                                                            <span>{{ assigned_user.user.full_name }}</span>
                                                        </a>

                                                        <!-- Модальное окно -->
                                                        <div class="modal fade" id="userInfoModal-{{ assigned_user.user.id }}" tabindex="-1" role="dialog" aria-labelledby="userInfoModalLabel-{{ assigned_user.user.id }}" aria-hidden="true">
                                                            <div class="modal-dialog" role="document">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="userInfoModalLabel-{{ assigned_user.user.id }}">{{ assigned_user.user.full_name }}</h5>
                                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body text-center">
                                                                        <img src="{{ url_for('static', filename=assigned_user.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                             alt="Фото профиля"
                                                                             class="rounded-circle mb-3"
                                                                             style="width: 100px; height: 100px; object-fit: cover;">
                                                                        <h5>{{ assigned_user.user.full_name }}</h5>
                                                                        <p><strong>Внутренний номер:</strong> {{ assigned_user.user.internal_id }}</p>
                                                                        <p><strong>Email:</strong> {{ assigned_user.user.email }}</p>
                                                                        <p><strong>Телефон:</strong> {{ assigned_user.user.phone_number }}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                        {% else %}
                                                        <span class="text-muted">Не назначены</span>
                                                        {% endif %}
                                                    </p>
                                                    <!-- Chat-style Comments -->
                                                    <h6 class="mt-3"><i class="fas fa-comments text-info"></i> Комментарии:</h6>
                                                    <div class="chat-container p-3" style="background-color: #f8f9fa; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                                                        {% for comment in task.comments|reverse %}
                                                        <div class="d-flex align-items-start mb-3">
                                                            <img src="{{ url_for('static', filename=comment.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                 alt="Фото профиля"
                                                                 class="rounded-circle mr-3"
                                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                                            <div class="p-2 rounded" style="background-color: #e3f2fd; border: 1px solid #ddd; border-radius: 10px; max-width: 80%;">
                                                                <strong class="text-primary">{{ comment.user.full_name }}</strong>
                                                                <p class="mb-1">{{ comment.content }}</p>
                                                                <small class="text-muted">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                        {% if not task.comments %}
                                                        <p class="text-muted text-center">Комментариев пока нет.</p>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Add Comment Form -->
                                                    <form action="{{ url_for('main_routes.add_comment') }}" method="POST" class="mt-3">
                                                        <input type="hidden" name="task_id" value="{{ task.id }}">
                                                        <div class="form-group">
                                                            <label for="commentContent-{{ task.id }}">Добавить комментарий:</label>
                                                            <textarea class="form-control" id="commentContent-{{ task.id }}" name="content" rows="2" required></textarea>
                                                        </div>
                                                        <button type="submit" class="btn btn-sm btn-primary">Отправить</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <p class="text-center text-muted">Нет задач</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Done Column -->
                            <div class="col-md-4">
                                <div class="card shadow-sm" style="border-radius: 10px;">
                                    <div class="card-header bg-success text-white text-center" style="border-radius: 10px 10px 0 0;">
                                        <strong>Выполнено</strong>
                                    </div>
                                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                        {% for task in selected_project.tasks if task.status.name == 'Выполнено' %}
                                        <div class="card mb-3 shadow-sm">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-tasks text-info"></i> {{ task.title }}
                                                </h6>
                                                <button class="btn btn-sm btn-outline-success" data-toggle="collapse" data-target="#task-{{ task.id }}" aria-expanded="false" aria-controls="task-{{ task.id }}">Подробнее</button>
                                                <div id="task-{{ task.id }}" class="collapse mt-2">
                                                    <p><i class="fas fa-align-left text-primary"></i> {{ task.description }}</p>
                                                    <p><i class="fas fa-calendar-alt text-warning"></i> <strong>Дедлайн:</strong> {{ task.deadline.strftime('%d.%m.%Y') if task.deadline else 'Не установлен' }}</p>
                                                    <p><i class="fas fa-user-friends text-success"></i> <strong>Ответственные:</strong>
                                                        {% if task.assigned_users %}
                                                        {% for assigned_user in task.assigned_users %}
                                                        <a href="#" data-toggle="modal" data-target="#userInfoModal-{{ assigned_user.user.id }}" class="d-flex align-items-center text-decoration-none mt-2">
                                                            <img src="{{ url_for('static', filename=assigned_user.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                 alt="Фото профиля"
                                                                 class="rounded-circle mr-2"
                                                                 style="width: 30px; height: 30px; object-fit: cover;">
                                                            <span>{{ assigned_user.user.full_name }}</span>
                                                        </a>

                                                        <!-- Модальное окно -->
                                                        <div class="modal fade" id="userInfoModal-{{ assigned_user.user.id }}" tabindex="-1" role="dialog" aria-labelledby="userInfoModalLabel-{{ assigned_user.user.id }}" aria-hidden="true">
                                                            <div class="modal-dialog" role="document">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="userInfoModalLabel-{{ assigned_user.user.id }}">{{ assigned_user.user.full_name }}</h5>
                                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body text-center">
                                                                        <img src="{{ url_for('static', filename=assigned_user.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                             alt="Фото профиля"
                                                                             class="rounded-circle mb-3"
                                                                             style="width: 100px; height: 100px; object-fit: cover;">
                                                                        <h5>{{ assigned_user.user.full_name }}</h5>
                                                                        <p><strong>Внутренний номер:</strong> {{ assigned_user.user.internal_id }}</p>
                                                                        <p><strong>Email:</strong> {{ assigned_user.user.email }}</p>
                                                                        <p><strong>Телефон:</strong> {{ assigned_user.user.phone_number }}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                        {% else %}
                                                        <span class="text-muted">Не назначены</span>
                                                        {% endif %}
                                                    </p>
                                                    <!-- Chat-style Comments -->
                                                    <h6 class="mt-3"><i class="fas fa-comments text-info"></i> Комментарии:</h6>
                                                    <div class="chat-container p-3" style="background-color: #f8f9fa; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                                                        {% for comment in task.comments|reverse %}
                                                        <div class="d-flex align-items-start mb-3">
                                                            <img src="{{ url_for('static', filename=comment.user.profile_picture or 'users/default_profile_picture.jpg') }}"
                                                                 alt="Фото профиля"
                                                                 class="rounded-circle mr-3"
                                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                                            <div class="p-2 rounded" style="background-color: #e3f2fd; border: 1px solid #ddd; border-radius: 10px; max-width: 80%;">
                                                                <strong class="text-primary">{{ comment.user.full_name }}</strong>
                                                                <p class="mb-1">{{ comment.content }}</p>
                                                                <small class="text-muted">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                        {% if not task.comments %}
                                                        <p class="text-muted text-center">Комментариев пока нет.</p>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Add Comment Form -->
                                                    <form action="{{ url_for('main_routes.add_comment') }}" method="POST" class="mt-3">
                                                        <input type="hidden" name="task_id" value="{{ task.id }}">
                                                        <div class="form-group">
                                                            <label for="commentContent-{{ task.id }}">Добавить комментарий:</label>
                                                            <textarea class="form-control" id="commentContent-{{ task.id }}" name="content" rows="2" required></textarea>
                                                        </div>
                                                        <button type="submit" class="btn btn-sm btn-primary">Отправить</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <p class="text-center text-muted">Нет задач</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center mt-4">
                <h1 class="mb-4">Добро пожаловать в управление проектами</h1>
                <p class="text-muted">Выберите проект в левой панели, чтобы увидеть подробную информацию.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно информации о менеджере -->
<div class="modal fade" id="managerInfoModal" tabindex="-1" role="dialog" aria-labelledby="managerInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="managerInfoModalLabel">Информация о менеджере</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {% if selected_project.manager %}
                <div class="text-center">
                    <img src="{{ url_for('static', filename=selected_project.manager.profile_picture or 'users/default_profile_picture.jpg') }}"
                         alt="Фото менеджера"
                         class="rounded-circle mb-3"
                         style="width: 80px; height: 80px; object-fit: cover;">
                    <h5>{{ selected_project.manager.full_name }}</h5>
                    <p><strong>Email:</strong> {{ selected_project.manager.email }}</p>
                    <p><strong>Телефон:</strong> {{ selected_project.manager.phone_number }}</p>
                </div>
                {% else %}
                <p class="text-muted">Информация о менеджере недоступна.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно создания задачи -->
<div class="modal fade" id="createTaskModal" tabindex="-1" role="dialog" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTaskModalLabel">Создать новую задачу</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="{{ url_for('main_routes.create_task') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="project_id" value="{{ selected_project.id }}">
                    <div class="form-group">
                        <label for="taskTitle">Название задачи</label>
                        <input type="text" class="form-control" id="taskTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Описание</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">Статус</label>
                        <select class="form-control" id="taskStatus" name="status_id" required>
                            <option value="" disabled selected>Выберите статус</option>
                            {% for status in task_statuses %}
                            <option value="{{ status.id }}">{{ status.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Приоритет</label>
                        <select class="form-control" id="taskPriority" name="priority" required>
                            <option value="1">Высокий</option>
                            <option value="2">Средний</option>
                            <option value="3">Низкий</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskDeadline">Дедлайн</label>
                        <input type="date" class="form-control" id="taskDeadline" name="deadline">
                    </div>
                    <div class="form-group">
                        <label for="assignedUsers">Ответственные</label>
                        <select class="form-control" id="assignedUsers" name="assigned_user_ids" multiple required>
                            {% for user in all_users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const canvas = document.getElementById('taskStatsChart');

        if (canvas) {
            const ctx = canvas.getContext('2d');
            const taskData = [
                {{ selected_project.tasks|selectattr('status.name', 'equalto', 'К выполнению')|list|length }},
                {{ selected_project.tasks|selectattr('status.name', 'equalto', 'В процессе')|list|length }},
                {{ selected_project.tasks|selectattr('status.name', 'equalto', 'Выполнено')|list|length }}
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['К выполнению', 'В процессе', 'Выполнено'],
                    datasets: [{
                        data: taskData,
                        backgroundColor: ['#ffc107', '#ff6347', '#28a745'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                    }
                }
            });
        }
    });
</script>

{% endblock %}
